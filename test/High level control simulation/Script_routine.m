clear;
close;
clc;

load("kneeangles_cut.mat")
gf_v = 2;
gf_a = (pi/180);
ds_val = 2;



previous_i = 1;

%[delay,setpoint,range,P,I,D,Vel_limit]
rf_points_2 = [
    50,25,1,-1,-1,-1,25;
    25,-25,1,-1,-1,-1,25;
    0,-50,1,-1,-1,-1,10;
    200,-40,1,-1,-1,-1,6;
    0,100,1,-1,-1,-1,45;
    0,150,1,-1,-1,-1,25;
    50,100,1,-1,-1,-1,15;
    0,0,1,-1,-1,-1,30
    ];




ka_ds = downsample(kneeangles_cut,ds_val)
rf_points = zeros(size(ka_ds,1),7)

for l = 1:1:size(ka_ds,1)
    if l == 1
        rf_points(l,:) = [0,ka_ds(l)*gf_a,0.05,-1,-1,-1,abs((ka_ds(l+1)-ka_ds(l))*gf_v)] ;
    else
        rf_points(l,:) = [0,ka_ds(l)*gf_a,0.05,-1,-1,-1,abs((ka_ds(l)-ka_ds(l-1))*gf_v)] ;
    end
end


rf_points = [
0,	0.0191986217719376,	0.0100000000000000,	-1,	-1,	-1,	8.00000000000000;
0,	0.0890117918517108,	0.0100000000000000,	-1,	-1,	-1,	8.00000000000000;
0,	0.171042266695444,	0.0100000000000000,	-1,	-1,	-1,	9.40000000000000;
0,	0.244346095279206,	0.0100000000000000,	-1,	-1,	-1,	8.40000000000000;
0,	0.282743338823081,	0.0100000000000000,	-1,	-1,	-1,	4.40000000000000;
0,	0.277507351067098,	0.0100000000000000,	-1,	-1,	-1,	0.599999999999998;
0,	0.247836753783195,	0.0100000000000000,	-1,	-1,	-1,	3.40000000000000;
0,	0.214675497995303,	0.0100000000000000,	-1,	-1,	-1,	3.80000000000000;
0,	0.186750229963393,	0.0100000000000000,	-1,	-1,	-1,	3.20000000000000;
0,	0.164060949687467,	0.0100000000000000,	-1,	-1,	-1,	2.60000000000000;
0,	0.143116998663535,	0.0500000000000000,	-1,	-1,	-1,	2.40000000000000;
0,	0.122173047639603,	0.0500000000000000,	-1,	-1,	-1,	2.40000000000000;
25,	0.102974425867665,	0.0500000000000000,	-1,	-1,	-1,	2.20000000000000;
50,0.0907571211037051,	0.0500000000000000,	-1,	-1,	-1,	1.40000000000000;
100,	0.0959931088596881,	0.0500000000000000,	-1,	-1,	-1,	0.600000000000000;
40,	0.127409035395586,	0.0500000000000000,	-1,	-1,	-1,	3.60000000000000;
40,	0.190240888467382,	0.0500000000000000,	-1,	-1,	-1,	7.20000000000000;
0,	0.282743338823081,	0.0500000000000000,	-1,	-1,	-1,	10.6000000000000;
0,	0.410152374218667,	0.0500000000000000,	-1,	-1,	-1,	14.6000000000000;
0,	0.565486677646163,	0.0500000000000000,	-1,	-1,	-1,	17.8000000000000;
0,	0.741764932097590,	0.0500000000000000,	-1,	-1,	-1,	20.2000000000000;
0,	0.914552528045029,	0.0500000000000000,	-1,	-1,	-1,	19.8000000000000;
0,	1.05417886820458,	0.0500000000000000,	-1,	-1,	-1,	16;
0,	1.14144533080429,	0.0500000000000000,	-1,	-1,	-1,	10.0000000000000;
0,	1.16238928182822,	0.0500000000000000,	-1,	-1,	-1,	2.39999999999998;
0,	1.11526539202438,	0.0500000000000000,	-1,	-1,	-1,	5.39999999999999;
50,	1.01229096615671,	0.0500000000000000,	-1,	-1,	-1,	11.8000000000000;
0,	0.870919296745170,	0.0500000000000000,	-1,	-1,	-1,	16.2000000000000;
0,	0.698131700797732,	0.0500000000000000,	-1,	-1,	-1,	19.8000000000000;
0,	0.499164166070378,	0.0500000000000000,	-1,	-1,	-1,	22.8000000000000;
0,	0.287979326579064,	0.0500000000000000,	-1,	-1,	-1,	24.2000000000000;
0,	0.101229096615671,	0.0500000000000000,	-1,	-1,	-1,	21.4000000000000;    
];

device = serialport("COM3",115200);

subplot(2,1,1);
h=plot(NaN,NaN,'r');
drawnow;
hold on

subplot(2,1,2)
d=plot(ka_ds,'b');
drawnow
hold on

tw = 10000;
drw_t = 3;
timeout = 4000;

pos = zeros(1,2000);
time = zeros(1,2000);

i = 1; % index for data acquisition
j = 1; % index for row of the point matrix
k = 1; % index for the step of the state space machine

while(1)


    if(k == 1 && rf_points(j,1) ~= -1)  % se il parametro Ã¨ definito

        if(i >= previous_i + rf_points(j,k)) % aspetto e passo al parametro
            k=k+1;
        end

    else if (k == 1)
            k=k+1; % altrimenti passo subito al successivo
    end
    end

    if(k == 2)

        if(rf_points(j,4) ~= -1)
            writeline(device,"MP0");
        end
        if(rf_points(j,5) ~= -1)
            writeline(device,"MI0");
        end
        if(rf_points(j,6) ~= -1)
            writeline(device,"MD0");
        end
        if(rf_points(j,7) ~= -1)
            writeline(device,"MLV" + string(rf_points(j,7)));
        end

        if(rf_points(j,2) ~= -1)

            writeline(device,"M" + string(rf_points(j,2)))

        end
        k=k+1;
    end

    if(k == 3)

        if(pos(i) > rf_points(j,2) - rf_points(j,3) && pos(i) < rf_points(j,2) + rf_points(j,3))
            k=1;
            previous_i = i;

            j=j+1;

            if(j > size(rf_points,1))
                j=size(rf_points,1);
                k=4;
                %break
            end
        end

        if((i-previous_i) >= (timeout))
            break
        end

    end

    if (k == 4 )
        if((i-previous_i) >= (timeout))
            break
        end
    end

    line = readline(device);

    if (contains(line,"Data:"))
        i=i+1;
        data = extractAfter(line,"Data:");

        pat = asManyOfPattern(wildcardPattern(1,inf,"Except",whitespacePattern),1);
        data_array = extract(data,pat)
        pos(i) = str2double(data_array(2));
        time(i) = i;
    end

    if (rem(i,drw_t) == 0)
        if i<=tw
            set(h, 'YData', pos(1:i));
            set(h, 'XData', time(1:i));
        else
            set(h, 'YData', pos(i-tw:i));
            set(h, 'XData', time(i-tw:i));
            xlim([time(i-tw) time(i)]);
        end
        drawnow;
    end

    %toc
end